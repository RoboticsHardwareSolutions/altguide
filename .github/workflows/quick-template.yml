name: Quick Template Download

on:
  workflow_dispatch:
    inputs:
      template_name:
        description: 'Template name (e.g., MyProject)'
        required: false
        default: 'rhs-altium-template'
        type: string

jobs:
  create-quick-template:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            files
            altguide.md
          sparse-checkout-cone-mode: false
        
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
        
      - name: Create template directory
        run: |
          mkdir -p "${{ inputs.template_name }}"
          
      - name: Copy template files
        run: |
          # Copy all files from files directory
          cp -r files/* "${{ inputs.template_name }}/"
          
          # Copy documentation
          cp altguide.md "${{ inputs.template_name }}/PROJECT_SETUP_GUIDE.md"
          
      - name: Create quick template README
        run: |
          cat > "${{ inputs.template_name }}/TEMPLATE_INFO.md" << 'EOF'
          # RHS Altium Project Template
          
          **Project Name:** ${{ inputs.template_name }}
          **Generated on:** ${{ steps.date.outputs.date }}
          
          ## Quick Setup:
          1. Rename files for your project
          2. Update README.md with project details  
          3. Configure .github/workflows as needed
          4. Start developing!
          
          For detailed instructions see PROJECT_SETUP_GUIDE.md
          EOF
          
      - name: Create template archive
        run: |
          zip -r "${{ inputs.template_name }}-${{ steps.date.outputs.date }}.zip" "${{ inputs.template_name }}/"
          
      - name: Save template locally
        run: |
          # Create local storage directory if it doesn't exist
          mkdir -p /home/runner/template-storage
          
          # Move archive to local storage
          mv "${{ inputs.template_name }}-${{ steps.date.outputs.date }}.zip" /home/runner/template-storage/
          
          # Set permissions
          chmod 644 "/home/runner/template-storage/${{ inputs.template_name }}-${{ steps.date.outputs.date }}.zip"
          
          # Log the location
          echo "Template saved to: /home/runner/template-storage/${{ inputs.template_name }}-${{ steps.date.outputs.date }}.zip"
          
      - name: Add download link to summary
        run: |
          echo "## ðŸ“¦ Template Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Template Name:** ${{ inputs.template_name }}-${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project Name:** ${{ inputs.template_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "Template saved locally on self-hosted runner:" >> $GITHUB_STEP_SUMMARY
          echo "\`/home/runner/template-storage/${{ inputs.template_name }}-${{ steps.date.outputs.date }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Contents:" >> $GITHUB_STEP_SUMMARY
          echo "- Altium PCB template" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions workflows" >> $GITHUB_STEP_SUMMARY  
          echo "- Documentation templates" >> $GITHUB_STEP_SUMMARY
          echo "- Board options and BOM templates" >> $GITHUB_STEP_SUMMARY
