name: Quick Template Download

on:
  workflow_dispatch:
    inputs:
      template_name:
        description: 'Template name (e.g., MyProject)'
        required: false
        default: 'rhs-altium-template'
        type: string
      include_altlib:
        description: 'Include altlib directory (large files - increases build time)'
        required: false
        default: false
        type: boolean

jobs:
  create-quick-template:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            files
            altguide.md
          sparse-checkout-cone-mode: false
          
      - name: Checkout altlib if needed
        if: inputs.include_altlib == true
        uses: actions/checkout@v4
        with:
          path: altlib-temp
          fetch-depth: 1
          sparse-checkout: |
            altlib
          sparse-checkout-cone-mode: false
      
      - name: Move altlib to correct location
        if: inputs.include_altlib == true
        run: |
          mv altlib-temp/altlib ./altlib
          rm -rf altlib-temp
        
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
        
      - name: Create template directory
        run: |
          mkdir -p "${{ inputs.template_name }}"
          
      - name: Copy template files
        run: |
          # Copy all files from files directory
          cp -r files/* "${{ inputs.template_name }}/"
          
          # Copy altlib if requested
          if [ "${{ inputs.include_altlib }}" = "true" ]; then
            cp -r altlib "${{ inputs.template_name }}/"
          fi
          
          # Copy documentation
          cp altguide.md "${{ inputs.template_name }}/PROJECT_SETUP_GUIDE.md"
          
      - name: Create quick template README
        run: |
          cat > "${{ inputs.template_name }}/TEMPLATE_INFO.md" << 'EOF'
          # RHS Altium Project Template
          
          **Project Name:** ${{ inputs.template_name }}
          **Generated on:** ${{ steps.date.outputs.date }}
          **Altlib included:** ${{ inputs.include_altlib }}
          
          ## Quick Setup:
          1. Rename files for your project
          2. Update README.md with project details  
          3. Configure .github/workflows as needed
          4. Start developing!
          
          For detailed instructions see PROJECT_SETUP_GUIDE.md
          EOF
          
      - name: Create template archive
        run: |
          zip -r "${{ inputs.template_name }}-${{ steps.date.outputs.date }}.zip" "${{ inputs.template_name }}/"
          
      - name: Upload template artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.template_name }}-${{ steps.date.outputs.date }}
          path: ${{ inputs.template_name }}-${{ steps.date.outputs.date }}.zip
          retention-days: 1
          
      - name: Add download link to summary
        run: |
          echo "## ðŸ“¦ Template Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Template Name:** ${{ inputs.template_name }}-${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project Name:** ${{ inputs.template_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Altlib Included:** ${{ inputs.include_altlib }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "Go to the Actions tab â†’ This workflow run â†’ Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Contents:" >> $GITHUB_STEP_SUMMARY
          echo "- Altium PCB template" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions workflows" >> $GITHUB_STEP_SUMMARY  
          echo "- Documentation templates" >> $GITHUB_STEP_SUMMARY
          echo "- Board options and BOM templates" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.include_altlib }}" = "true" ]; then
            echo "- RHS component libraries" >> $GITHUB_STEP_SUMMARY
          fi
